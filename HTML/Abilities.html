<!doctype html>
<html lang="en">
    <head>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-CC3NE8PT7K"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());
            gtag("config", "G-CC3NE8PT7K");
        </script>
        <link rel="shortcut icon" type="image/x-icon" href="/aow4db/favicon.ico" />
        <link rel="stylesheet" type="text/css" href="/aow4db/Style/style.css" />
        <meta charset="UTF-8" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="/aow4db/Data/Builder.js"></script>
        <script src="/aow4db/Data/Faction.js"></script>
        <script src="/aow4db/Data/Search.js"></script>

        <script>
            function HandlePage() {
                CreateAllAbility();
                SetLevelUpStuff();
                $("#filterInput").on("change input", function () {
                    ShowAllAbilitiesWithFilters();
                    SetLevelUpStuff();
                });
            }

            function CreateAllAbility() {
                for (i = 0; i < jsonUnitAbilitiesLocalized.length; i++) {
                    if ("actionPoints" in jsonUnitAbilitiesLocalized[i]) {
                        addAbility(jsonUnitAbilitiesLocalized[i].slug);
                    }
                }
            }

            function HideAll() {
                const divs = document.getElementsByClassName("list_abilityslot");

                for (let i = 0; i < divs.length; i++) {
                    const div = divs[i];
                    div.style.display = "none";
                }
            }

            function ShowAllAbilitiesWithFilters() {
                HideAll();
                var list = new Array();
                var filter = document.getElementById("filterInput");

                var filterText = filter.value.toUpperCase();

                for (i = 0; i < jsonUnitAbilitiesLocalized.length; i++) {
                    var ability = jsonUnitAbilitiesLocalized[i];
                    if (filterText != "") {
                        if (ability.name.toUpperCase().indexOf(filterText) != -1) {
                            if (!isInArray(list, ability.slug)) {
                                list.push(ability.slug);
                            }
                        }

                        if ("accuracy" in ability) {
                            if (ability.accuracy.toUpperCase().indexOf(filterText) != -1) {
                                if (!isInArray(list, ability.slug)) {
                                    list.push(ability.slug);
                                }
                            }
                        }
                        if ("range" in ability) {
                            if (ability.range.toUpperCase().indexOf(filterText) != -1) {
                                if (!isInArray(list, ability.slug)) {
                                    list.push(ability.slug);
                                }
                            }
                        }

                        if ("description" in ability) {
                            if (ability.description.toUpperCase().indexOf(filterText) != -1) {
                                if (!isInArray(list, ability.slug)) {
                                    list.push(ability.slug);
                                }
                            }
                        }

                        if ("actionPoints" in ability) {
                            if (ability.actionPoints.toUpperCase().indexOf(filterText) != -1) {
                                if (!isInArray(list, ability.slug)) {
                                    list.push(ability.slug);
                                }
                            }
                        }

                        if ("damage" in ability) {
                            if (ability.damage.toUpperCase().indexOf(filterText) != -1) {
                                if (!isInArray(list, ability.slug)) {
                                    list.push(ability.slug);
                                }
                            }
                        }

                        if ("modifiers" in ability) {
                            for (j = 0; j < ability.modifiers.length; j++) {
                                if (ability.modifiers[j].description.toUpperCase().indexOf(filterText) != -1) {
                                    if (!isInArray(list, ability.slug)) {
                                        list.push(ability.slug);
                                    }
                                }
                                if (ability.modifiers[j].name.toUpperCase().indexOf(filterText) != -1) {
                                    if (!isInArray(list, ability.slug)) {
                                        list.push(ability.slug);
                                    }
                                }
                            }
                        }
                        if ("requisites" in ability) {
                            for (j = 0; j < ability.requisites.length; j++) {
                                if (ability.requisites[j].requisite.toUpperCase().indexOf(filterText) != -1) {
                                    if (!isInArray(list, ability.slug)) {
                                        list.push(ability.slug);
                                    }
                                }
                            }
                        }
                    } else {
                        if (!isInArray(list, ability.slug)) {
                            list.push(ability.slug);
                        }
                    }
                }

                ProcessList(list);
            }

            function ProcessList(list) {
                for (i = 0; i < list.length; i++) {
                    var abilityDiv = document.getElementById(list[i] + "btn");

                    if (abilityDiv != undefined) {
                        abilityDiv.style.display = "flex";
                    }
                }
            }

            function addAbility(a, b) {
                const holder = document.getElementById("dataHolder");

                const abilityData = jsonUnitAbilitiesLocalized.find((item) => item.slug === a);
                if (!abilityData) return;

                // Extract and default
                const {
                    name = "",
                    icon = "",
                    description = "",
                    damage = "",
                    accuracy = "",
                    range = "",
                    actionPoints = "",
                    modifiers = [],
                    requisites = [],
                    notes = []
                } = abilityData;

                let abilityMod = "";
                let abilityName = name;

                // Handle modifiers
                if (modifiers.length > 0) {
                    modifiers.forEach((mod) => {
                        abilityName += "&#11049";
                        abilityMod += `<bullet>${AddTagIconsForStatusEffects(mod.name)}<br>${mod.description}</bullet><br>`;
                    });
                }

                // Handle notes
                let abilityNote = "";
                let Cooldown = "";
                let Once = "";

                notes.forEach(({ note }) => {
                    if (!note) return;
                    if (note.includes("Cooldown")) Cooldown = note;
                    else if (note.includes("once per")) Once = note;
                    else abilityNote += "<br>" + note;
                });

                // Requisites
                let requisitesDisplay = "";
                if (requisites.length > 0) {
                    requisitesDisplay = "(" + requisites.map((r) => r.requisite).join(", ") + ")";
                }

                // Build button
                const btn = createElement("div", "list_abilityslot", { id: `${a}btn` });

                // Icon
                const img = createElement("img", "unit_ability_icon");
                const iconType = GetAbilityBackground(damage);
                img.src = `/aow4db/Icons/UnitIcons/${icon}.png`;
                img.onerror = function () {
                    this.src = "/aow4db/Icons/Text/mp.png";
                };
                img.width = 40;
                img.height = 40;
                img.style.backgroundImage = `url("/aow4db/Icons/Interface/${iconType}.png")`;
                img.style.backgroundRepeat = "no-repeat";
                img.style.backgroundSize = "40px 40px";

                // Tooltip text
                const tooltipText = createElement("div", "tooltip");
                tooltipText.innerHTML = abilityName;
                tooltipText.style.color = "white";
                tooltipText.style.width = "250px";

                // Tooltip content
                let spa = GetAbilityToolTip(
                    abilityData,
                    damage,
                    abilityName,
                    iconType,
                    `${accuracy}<accuracy></accuracy>`,
                    `${range}<range></range>`,
                    abilityMod,
                    "", // enchantments (unused)
                    abilityNote,
                    requisites,
                    Cooldown,
                    Once
                );

                // Special formatting
                if (abilityName.includes("Defense Mode")) {
                    spa.innerHTML = `<div class="leftAbility" style="color:#d7c297;">${abilityName.toUpperCase()}</div><div style="clear:both"></div><br>${description}`;
                }

                // Apply tooltip listeners
                addTooltipListeners(tooltipText, spa);

                // Info columns
                const colStyle = "color:white;";
                const appendCol = (text, className, width) => {
                    const col = createElement("div", className);
                    col.innerHTML = text;
                    col.style = `${colStyle} width:${width}`;
                    btn.append(col);
                };

                btn.append(img);
                btn.append(tooltipText);
                appendCol(range, "list_range", "70px");
                appendCol(accuracy, "list_accuracy", "150px");
                appendCol(damage, "ability_damage", "150px");
                appendCol(actionPoints, "list_action", "100px");

                if (requisites.length > 0) {
                    const reqDiv = createElement("div", "list_types");
                    reqDiv.innerHTML = requisitesDisplay;
                    reqDiv.style = `${colStyle} width:200px; font-size:12px`;
                    btn.append(reqDiv);
                }

                holder.append(btn);
            }

            // ðŸ”§ Helper: createElement
            function createElement(tag, className, attrs = {}) {
                const el = document.createElement(tag);
                if (className) el.className = className;
                Object.entries(attrs).forEach(([key, value]) => {
                    el.setAttribute(key, value);
                });
                return el;
            }

            function findSource(slug) {
                for (var i = 0; i < jsonUnitsLocalized[i].abilities.length; i++) {
                    if (jsonUnitsLocalized[i].abilities[0].slug == slug) {
                        return jsonUnitsLocalized[i].name;
                    }
                }
                return slug;
            }

            function sortDivsList(sortType) {
                var i = "";

                // ascendingOrder = !ascendingOrder;

                var buttontargets = document.getElementsByClassName("sortingButton");

                var currentbutton = document.getElementById(sortType + "-button");

                if (currentbutton.className.indexOf(" activeDown") != -1) {
                    ascendingOrder = false;
                } else {
                    ascendingOrder = true;
                }

                for (i in buttontargets) {
                    buttontargets[i].className = "sortingButton";
                }
                if (ascendingOrder) {
                    currentbutton.className += " activeDown";
                } else {
                    currentbutton.className += " activeUp";
                }

                // 3 - Choose the wanted order
                //  ascendingOrder = !ascendingOrder;
                const isNumeric = true;

                // 4 - Select all elements
                if (currentView === "") {
                    var container = document.getElementById("dataHolder");
                } else {
                    var container = document.getElementById(currentView);
                }

                var element = (elements = [...container.querySelectorAll(".list_abilityslot")]);

                var selector = (element) => element.querySelector(".tooltip").innerHTML;
                if (sortType === "range") {
                    selector = (element) => element.querySelector(".list_range").innerHTML;
                }
                if (sortType === "accuracy") {
                    selector = (element) => element.querySelector(".list_accuracy").innerHTML;
                }

                if (sortType === "damage") {
                    selector = (element) => element.querySelector(".ability_damage").innerHTML;
                }

                if (sortType === "action") {
                    selector = (element) => element.querySelector(".list_action").innerHTML;
                }
                if (sortType === "type") {
                    selector = (element) => element.querySelector(".list_types").innerHTML;
                }

                // 5 - Find their parent
                const parentElement = container;

                // 6 - Sort the elements
                const collator = new Intl.Collator(undefined, {
                    numeric: isNumeric,
                    sensitivity: "base"
                });

                elements
                    .sort((elementA, elementB) => {
                        const [firstElement, secondElement] = ascendingOrder
                            ? [elementA, elementB]
                            : [elementB, elementA];

                        var textOfFirstElement = selector(firstElement);

                        var textOfSecondElement = selector(secondElement);
                        if (sortType === "tier") {
                            var fields = textOfFirstElement.split("Tier ", 3);
                            textOfFirstElement = deromanize(fields[1]);
                            var fields2 = textOfSecondElement.split("Tier ", 3);
                            textOfSecondElement = deromanize(fields2[1]);
                        }

                        return collator.compare(textOfFirstElement, textOfSecondElement);
                    })
                    .forEach((element) => parentElement.appendChild(element));

                // var currenturl = window.location.href.split('&')[0];

                // window.history.replaceState({}, 'foo', currenturl + "&sort=" + sortType + ":" + ascendingOrder);
                sorting = sortType + ":" + ascendingOrder;
            }
        </script>

        <title>Age of Wonders 4 Database - Abilities List</title>
    </head>

    <body>
        <div class="textblocktitle">Abilities List</div>
        <div style="height: auto; color: white; text-align: center">
            <br />
            Filter<br />
            <div style="margin-right: auto; margin-left: auto; width: 500px">
                <input type="text" class="searchbar" id="filterInput" />
            </div>
        </div>

        <div class="w3-container">
            <div class="w3-bar w3-black" id="buttonHolder"></div>
            <div class="list_abilityslotfilter">
                <button style="width: 300px" class="sortingButton" id="name-button" onclick="sortDivsList('name')">
                    Name
                </button>
                <button style="width: 80px" class="sortingButton" id="range-button" onclick="sortDivsList('range')">
                    Range <range></range>
                </button>
                <button
                    style="width: 150px"
                    class="sortingButton"
                    id="accuracy-button"
                    onclick="sortDivsList('accuracy')">
                    Acc.<br />
                    <accuracy></accuracy>
                </button>
                <button style="width: 150px" class="sortingButton" id="damage-button" onclick="sortDivsList('damage')">
                    Damage<br />
                    <damageblight></damageblight>
                </button>
                <button style="width: 100px" class="sortingButton" id="action-button" onclick="sortDivsList('action')">
                    Action <repeatingAction></repeatingAction>
                </button>
                <button style="width: 200px" class="sortingButton" id="type-button" onclick="sortDivsList('type')">
                    Type
                </button>
            </div>
            <div id="dataHolder" class="divContainer"></div>
        </div>
    </body>
</html>
<footer>
    <br />
    <br />
</footer>
