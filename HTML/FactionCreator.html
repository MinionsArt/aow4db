<!doctype html>
<html lang="en">
    <head>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-CC3NE8PT7K"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-CC3NE8PT7K");
        </script>

        <link rel="shortcut icon" type="image/x-icon" href="/aow4db/favicon.ico" />
        <link rel="stylesheet" type="text/css" href="/aow4db/Style/style.css" />
        <link rel="stylesheet" type="text/css" href="/aow4db/Style/icons.css" />
        <meta charset="UTF-8" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

        <style>
            button {
                font-family: "Regular", sans-serif;
            }

            .small_title {
                font-family: "Decorative";
                color: burlywood;
                font-size: 14px;
            }

            /* CSS styles for buttons */
            .button {
                background-color: #007bff00;
                color: #fff;
                border: none;
                position: relative;
                display: flex;
                justify-content: space-between;

                align-items: center;

                cursor: pointer;
            }

            /* CSS styles for buttons */
            .button2 {
                background-color: #007bff00;
                color: #fff;
                border: none;
                position: relative;
                display: flex;
                justify-content: space-between;

                align-items: center;

                cursor: pointer;
            }

            #notesDisplay {
                border: 1px solid #ccc;
                padding: 6px;
                min-height: 100px;
                width: 100%;
            }

            /* CSS styles for origin buttons */
            .origin-button {
                padding: 5px;
                background-color: #007bff;
                color: #fff;
                border: none;
                cursor: pointer;
                margin: 5px;
                border-radius: 5px;
            }

            .button-inset {
                background-color: #007bff00;
                color: #fff;
                border: none;
                cursor: pointer;
                position: relative;
                left: 30px;

                align-items: center;

                display: flex;
                justify-content: space-between;
            }

            .list-button {
                border-width: 3px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
                border-image-repeat: stretch;
                width: 100%;
                background-color: #111;
                color: #fff;
                /* border: none; */
                cursor: pointer;
                position: relative;
                z-index: 2;
                display: flex;
                justify-content: normal;
            }

            .list-button.selected {
                background-color: #4caf50;
                color: white;
            }

            .list-button-small {
                border-width: 3px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
                border-image-repeat: stretch;
                width: 60px;

                background-color: #111;
                color: #fff;
                /* border: none; */
                cursor: pointer;
                position: relative;
            }

            .list-button-disabled {
                border-width: 3px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
                border-image-repeat: stretch;
                width: 100%;
                background-color: #111;
                color: #ff1111;
                /* border: none; */
                cursor: pointer;
                position: relative;

                display: flex;
                filter: brightness(0.5);
                justify-content: normal;
            }

            .list-button-currentequipped {
                border-width: 3px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
                border-image-repeat: stretch;
                width: 100%;
                background-color: #347634;
                color: #fff;
                /* border: none; */
                cursor: pointer;
                position: relative;

                display: flex;
                justify-content: normal;
            }

            .list-button-long {
                /* border-width: 3px; */
                /* border-style: solid; */
                /* border-image: url(/aow4db/Icons/9slicetooltip.png); */
                /* border-image-slice: 10 10 10 10; */
                /* border-image-repeat: stretch; */
                width: 100px;
                height: 30px;
                background-color: #111;
                color: #fff;
                height: 60px;
                /* border: none; */
                cursor: pointer;
                position: relative;
            }

            .tome-button-small {
                width: 60px;
                height: 70px;

                color: #fff;
                /* border: none; */
                cursor: pointer;
                position: relative;
            }

            .skill-button-small {
                width: 80px;
                height: 80px;

                color: #fff;
                /* border: none; */
                cursor: pointer;
                position: relative;
            }

            .subDivider {
                display: flex;
                justify-content: space-between;
            }

            .list-button-small:hover,
            .list-button:hover,
            .button:hover,
            .button-inset:hover,
            .skill-button-small:hover,
            .tome-button-small:hover,
            .button-random:hover,
            .button-overview:hover {
                filter: brightness(200%);
            }

            .test {
                width: 20px;
                height: 20px;
                border-width: 5px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
            }

            .wrappers {
                position: relative;

                display: grid;
                grid-template-columns: repeat(7, 2fr);
                overflow-y: auto;
                max-height: 300px;
                height: fit-content;
            }

            .subSubDiv {
                min-height: 240px;
                width: 350px;
            }

            .subSubDiv2 {
                min-height: 130px;
                width: 350px;
            }

            .shield {
                float: left;
            }

            .symbol {
                position: absolute;
                /* float: left; */
                top: 12px;
                left: 14px;
            }

            .selections {
                width: fit-content;

                height: fit-content;
                max-height: 300px;
                color: white;
                display: inline-block;
                position: absolute;
                border-width: 10px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
                background-color: black;
            }

            .container {
                display: inline-block;
                position: relative;

                width: 700px;

                background-image: url(/aow4db/Icons/tooltipBG.png);

                background-size: cover;
                font-size: 13px;
                color: #bbcdf6;
                text-align: left;
                border-width: 10px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
                text-shadow: 2px 2px black;
            }

            .affinityText {
                top: 20px;
                max-width: 300px;
                font-size: 15px;
                position: relative;
            }

            .factioncreator {
                position: relative;
                display: flex;

                justify-content: center;
            }

            .AddSubtract {
                margin: -2px;
                font-weight: 900;
                color: white;
                background-color: transparent;
                border: none;
            }

            .overview {
                max-height: 650px;
                display: flex;
                align-content: flex-start;
                align-items: flex-start;
                flex-wrap: wrap;
                flex-direction: column;
            }

            .column {
                padding: 6px;
                font-size: 14px;
                font-family: "Decorative";
                color: burlywood;
            }

            .overview_list_entry {
                display: flex;
                box-sizing: border-box;
                min-width: 180px;
                min-height: 30px;
                max-width: 180px;
                text-overflow: ellipsis;
                white-space: nowrap;
                border-width: 3px;
                border-style: solid;
                border-image: url(/aow4db/Icons/9slicetooltip.png);
                border-image-slice: 10 10 10 10;
                border-image-repeat: stretch;
                overflow: hidden;
                background-color: rgb(17, 17, 17);

                font-size: 12px;
                color: white;
            }

            .overview_list_entry.highlighted {
                background-image: url(/aow4db/Icons/Interface/fav.png);
                background-repeat: no-repeat;
                background-position-x: 156px;
                background-size: 20px;
                background-color: rgb(24 42 64);
            }

            .overview_list_entry:hover {
                filter: brightness(200%);
            }

            .AddSubtract:hover {
                margin: -2px;
                font-weight: 1900;
                color: aqua;
                background-color: transparent;
                border: none;
            }

            .sortingButton:hover {
                background-color: dimgrey;
            }
        </style>

        <script>
            const namePrefixes = ["Arcane", "Feral", "Divine", "Cursed", "Mystic"];
            const nameTypes = ["Warlord", "Summoner", "Champion", "Sorcerer", "Guardian"];

            $("#body").ready(function () {
                $("#header").load("/aow4db/HTML/header.html", function () {
                    CheckData();
                });
            });

            function HandlePage() {
                
                // hide build submitter
             //   if (showBetaTooltip.checked) {
                    // get build section
               //         document.getElementById("shareSection").style.display= "none";
               //     document.getElementById("buildsSubmitHolder").style.display = "none";
               // }
                SetRandomStart();

                document.getElementById("YourKey").textContent = getOrCreateUserEditKey();

                var tooltip = document.getElementById("tooltipKey");
                var span = document.createElement("span");
                span.innerHTML =
                    "Important! <br>This key is used to load and delete your builds, it is stored in your browser data, please save it in case it gets wiped!. You can overwrite it using Load Key";
                addTooltipListeners(tooltip, span);
            }
        </script>

        <title>Age of Wonders 4 Database - Faction Creator</title>
    </head>

    <body>
        <div id="header"></div>

        <div class="tome_name">Faction creator</div>

        <div style="color: white; display: table; margin: 5px; margin-left: auto; margin-right: auto">
            <div></div>
            <div id="note"></div>
            <div id="shareSection">
            <button class="button-random" onclick="GetQuickLink()">Make Share Link</button>

            <input type="text" value="" class="inputfield" id="shareLink" style="width: 600px" />

            <button class="button-random" id="copyButton" onclick="myFunction()">Copy</button><br />
            </div>
            <div style="display: flex; flex-direction: row; justify-content: space-around">
                <button class="button-random" onclick="SetRandomStart(true)">Randomise</button><br />
                <button class="button-overview" style="left: 200px" id="toggleButton">◀ Hide Overview</button>
            </div>
        </div>

        <div class="factioncreator" id="capture">
            <div class="typeHolder" id="factioncreator">
                <div class="container">
                    <div style="height: 90px">
                        <div class="playerSigil">
                            <!-- <canvas id="myCanvas" class="shield" width="70" height="70" style="float:left"></canvas>
                        <canvas class="symbol" id="myCanvas2" width="50" height="50" style="float:left"></canvas>-->
                            <img
                                class="shield"
                                id="shield"
                                src="/aow4db/Icons/Interface/Sigil.png"
                                width="70px"
                                height="70px" />
                            <img class="symbol" id="symbol" src="/aow4db/Icons/Interface/symbol.png" height="45px" />
                        </div>
                        <!--  <button class="test" id="shieldColor" onclick="ChangeShieldCol()"> </button>
                    <button class="test" id="symbolColor" onclick="ChangeSymbolCol()"> </button>-->
                        <div style="display: flex; flex-direction: row; justify-content: space-between">
                            <div id="currentAffinity" class="affinityText"></div>
                            <div>
                                Extra Affinity Points
                                <div
                                    id="extraAffinity"
                                    style="
                                        max-width: 300px;
                                        display: flex;
                                        justify-content: space-evenly;
                                        background-color: #f0f8ff2b;
                                        position: relative;
                                    ">
                                    <div style="display: flex; height: 50px">
                                        <div id="extraOrder"></div>
                                        <div style="display: flex; flex-direction: column">
                                            <button class="AddSubtract" onclick="AddExtra('order','⮝')">⮝</button>
                                            <button class="AddSubtract" onclick="AddExtra('order','⮟')">⮟</button>
                                        </div>
                                    </div>

                                    <div style="display: flex; height: 50px">
                                        <div id="extraChaos"></div>

                                        <div style="display: flex; flex-direction: column">
                                            <button class="AddSubtract" onclick="AddExtra('chaos','⮝')">⮝</button>
                                            <button class="AddSubtract" onclick="AddExtra('chaos','⮟')">⮟</button>
                                        </div>
                                    </div>

                                    <div style="display: flex; height: 50px">
                                        <div id="extraNature"></div>
                                        <div style="display: flex; flex-direction: column">
                                            <button class="AddSubtract" onclick="AddExtra('nature','⮝')">⮝</button>
                                            <button class="AddSubtract" onclick="AddExtra('nature','⮟')">⮟</button>
                                        </div>
                                    </div>
                                    <div style="display: flex; height: 50px">
                                        <div id="extraShadow"></div>

                                        <div style="display: flex; flex-direction: column">
                                            <button class="AddSubtract" onclick="AddExtra('shadow','⮝')">⮝</button>
                                            <button class="AddSubtract" onclick="AddExtra('shadow','⮟')">⮟</button>
                                        </div>
                                    </div>
                                    <div style="display: flex; height: 50px">
                                        <div id="extraMaterium"></div>

                                        <div style="display: flex; flex-direction: column">
                                            <button class="AddSubtract" onclick="AddExtra('materium','⮝')">⮝</button>
                                            <button class="AddSubtract" onclick="AddExtra('materium','⮟')">⮟</button>
                                        </div>
                                    </div>
                                    <div style="display: flex; height: 50px">
                                        <div id="extraAstral"></div>

                                        <div style="display: flex; flex-direction: column">
                                            <button class="AddSubtract" onclick="AddExtra('astral','⮝')">⮝</button>
                                            <button class="AddSubtract" onclick="AddExtra('astral','⮟')">⮟</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br />
                        <hr />
                    </div>

                    <div class="subDivider">
                        <div style="width: 280px">
                            <div class="subSubDiv">
                                <div style="min-height: 200px">
                                    <span class="small_title"> Ruler</span>
                                    <input
                                        type="text"
                                        value="Ruler Name"
                                        pattern="[a-zA-Z0-9\s]+"
                                        class="inputfield"
                                        id="fname1"
                                        maxlength="35"
                                        name="fname" />

                                    <!--<input type="text" value="Title" class="inputfield" id="fname2" name="fname">-->
                                    <div id="buttonContainer">
                                        <button
                                            class="button"
                                            id="originButtonOrigin"
                                            onclick="SetupButtons(event,'Origin')"></button>
                                    </div>

                                    <div id="buttonContainer10">
                                        <button
                                            class="button-inset"
                                            id="originButtonSubType"
                                            onclick="SetupButtons(event,'SubType')"></button>
                                    </div>
                                    <div id="buttonContainer8">
                                        <button
                                            class="button-inset"
                                            id="originButtonClass"
                                            onclick="SetupButtons(event,'Class')"></button>
                                    </div>
                                    <div id="buttonContainer9">
                                        <button
                                            class="button-inset"
                                            id="originButtonTome"
                                            onclick="SetupButtons(event,'Tome')"></button>
                                    </div>
                                    <br /><br />
                                    <div id="buttonContainer7">
                                        <span class="small_title"> Ascension</span>
                                        <button
                                            style="float: right; color: red"
                                            class="button"
                                            onclick="ClearAscensionSkill()">
                                            X
                                        </button>
                                        <button
                                            class="button-inset"
                                            id="originButtonAscension"
                                            onclick="SetupButtons(event,'Ascension')">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- <div class="subSubDiv2">
                                <span class="small_title">Signature Skills</span>
                                <button style="float: right; color: red" class="button" onclick="RemoveLastSkill()">
                                    X
                                </button>
                                <div id="buttonContainer6" style="height: 100px">
                                    <button
                                        class="button2"
                                        id="originButtonSignature"
                                        onclick="SetupButtons(event,'Signature')">
                                        +
                                    </button>
                                </div>
                            </div>-->
                        </div>

                        <div style="width: 300px">
                            <div class="subSubDiv" style="min-height: 200px">
                                <span class="small_title"> Race</span>
                                <input
                                    type="text"
                                    class="inputfield"
                                    pattern="[a-zA-Z0-9\s]+"
                                    value="Race Name"
                                    id="fname"
                                    maxlength="35"
                                    name="fname" />

                                <div id="buttonContainer5">
                                    <button
                                        class="button"
                                        id="originButtonForm"
                                        onclick="SetupButtons(event,'Form')"></button>
                                </div>

                                <div id="buttonContainer4">
                                    <button
                                        style="
                                            background-color: transparent;
                                            min-height: 40px;
                                            min-width: 200px;
                                            border: none;
                                        "
                                        id="originButtonFormTrait"
                                        onclick="SetupButtons(event,'FormTrait')">
                                        <span id="selected-options-container" style="color: white"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="subSubDiv2">
                                <div id="buttonContainer3">
                                    <span class="small_title"> Culture & Society</span>
                                    <button
                                        class="button"
                                        id="originButtonCulture"
                                        onclick="SetupButtons(event,'Culture')"></button>
                                        <button
                                            class="button-inset"
                                            id="originButtonSubCulture"
                                            onclick="SetupButtons(event,'SubCulture')"></button>
                                </div>

                                <div id="buttonContainer2">
                                    <button
                                        class="button-inset"
                                        id="originButtonSociety1"
                                        onclick="SetupButtons(event,'Society1')"></button>
                                     <button
                                            class="button-inset"
                                            id="originButtonSubSociety1"
                                            onclick="SetupButtons(event,'SubSociety1')"></button>
                                </div>
                                <div id="buttonContainer1">
                                    <button
                                        class="button-inset"
                                        id="originButtonSociety2"
                                        onclick="SetupButtons(event,'Society2')"></button>
                                     <button
                                            class="button-inset"
                                            id="originButtonSubSociety2"
                                            onclick="SetupButtons(event,'SubSociety2')"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <hr />

                        <button class="button-inset" id="originButtonTome2"></button>

                        <span class="small_title"> Tome Path</span>

                        <button style="float: right; color: red" class="button" onclick="ClearTomePath()">
                            Clear All
                        </button>
                        <button
                            style="float: right; margin-right: 100px; color: red"
                            class="button"
                            onclick="RemoveLastTomePath()">
                            Clear Last
                        </button>
                        <br />
                        <div
                            style="display: grid; grid-template-columns: repeat(8, 2fr); margin: 15px"
                            id="tomePathButton"></div>
                    </div>
                </div>
            </div>
            <div style="color: white; display: block" id="overviewPanel">
                <button class="button-random" onclick="ResetHighlights()" id="toggleButton1">
                    Reset <favourite></favourite>
                </button>
                <button class="button-random" onclick="ShowHideUnFavs()" id="toggleButton2">
                    Show/Hide non-<favourite></favourite>
                </button>
                <p><span id="active-indices"></span></p>
                <div class="overview" id="mainoverview">
                    <div class="column" id="overviewHeroSkillsHolder"></div>
                    <div class="column" id="overviewPassivesHolder"></div>
                    <div class="column" id="overviewSummonHolder"></div>
                    <div class="column" id="overviewCombatSpellsHolder"></div>
                    <div class="column" id="overviewTransformationsHolder"></div>
                    <div class="column" id="overviewEnchantmentsHolder"></div>
                    <div class="column" id="overviewOtherSpellHolder"></div>

                    <div class="column" id="overviewUnitsHolder"></div>
                    <div class="column" id="overviewUpgradesHolder"></div>
                    <div class="column" id="overviewSPIHolder"></div>
                    <div class="column" id="overviewSiegeHolder"></div>
                    <div class="column" id="overviewEmpireHolder"></div>
                </div>
            </div>
        </div>

        <div id="hiddentooltips" style="display: none"></div>

        <div class="selections" id="selectionsHolder">
            <p id="selections" style="text-align: center"></p>
            <button
                style="float: right; position: relative; top: -20px; color: red"
                class="button"
                onclick="toggleOriginButtons()">
                X
            </button>

            <div id="originWrapperOptions" class="wrappers"></div>
        </div>
        <br /><br />
        <div id="buildsSubmitHolder">
        <div id="notesContainer" style="color: white">
            <div>
                User Submitted Builds are in testing now.
                <button
                    class="button-random"
                    style="position: relative; top: 0; left: 50%; transform: translateX(-50%)">
                    <a href="/aow4db/HTML/FactionList.html"> BUILDS LIST</a>
                </button>
            </div>
            <label for="notesEditor">Build Notes:</label>
            <div id="notesDisplay"></div>
            <div id="NotesEditInput" style="display: none">
                <div style="margin-bottom: 5px; display: flex">
                    <button onclick="format('bold')"><b>Bold</b></button>
                    <button onclick="formatHeader('h1')">Header</button>
                    <div>Use [] for tags I.E. [hp] for <hp></hp></div>
                    <!-- <div>Use {} for highlights of abilities/spells/etc I.E. {Ancient Wise Ones}</div>-->
                </div>

                <div
                    id="NotesInput"
                    contenteditable="true"
                    style="
                        border: 1px solid gray;
                        padding: 10px;
                        min-height: 100px;
                        background: #454545;
                        color: white;
                        white-space: pre-wrap;
                    "></div>
            </div>
            <button id="editNotesBtn" onclick="toggleEditNotes()">Edit</button>
            <button style="display: none" id="saveNotesBtn" onclick="saveNotes()">Save</button>
        </div>
        <div style="display: flex; justify-content: space-around; color: white">
            <div style="color: white">
                <div style="width: fit-content">
                    <div id="tooltipKey">
                        YourEditKey: <img src="/aow4db/Icons/Text/exclamationpoint.png" height="20px" />
                    </div>
                    <button class="button-random" onmousedown="RevealKey()" onmouseup="HideKey()">👁️Show</button>
                    <span style="display: none" id="YourKey"></span>
                </div>
                <button class="button-random" onclick="CopyField()">📄Copy Key</button>
                <button class="button-random" onclick="downloadEditKeyFile()">💾Save Key</button>

                <button class="button-random" onmousedown="RevealKey()" onmouseup="ShowLoad()">📂Load Key</button>
                <div id="loadkey" style="display: none">
                    Overwrite key: <input type="text" id="overwriteKey" name="lname" /><button
                        class="button-random"
                        onclick="OverwriteEditKey()">
                        Submit
                    </button>
                </div>
            </div>

            <div
                id="loading-spinner"
                style="
                    display: none;
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 9999;
                ">
                <div class="spinner"></div>
            </div>

            <div style="color: white; display: none" id="oldURL"></div>

            <!-- Dropdown to choose a tag -->
            <div>
                <!-- Extra holder -->
                <label for="tagDropdown">Select a Tag:</label>
                <select id="tagDropdown">
                    <option value="">-- Choose a tag --</option>
                    <option value="Roleplay">Roleplay</option>
                    <option value="Theme">Theme</option>
                    <option value="PVP">PVP</option>
                    <option value="Casual">Casual</option>
                    <option value="Hardcore">Hardcore</option>
                </select>

                <button onclick="addTag()">Add Tag</button>

                <!-- Where tags will be listed -->
                <div id="tagList" style="margin-top: 10px"></div>
                <label for="userNotes">Build Name:</label>
                <input type="text" id="buildName" name="lname" />

                <button class="button-random" onclick="submitBuild()">Submit New</button>

                <button class="button-random" id="overwriteButton" style="display: none" onclick="overwriteBuild()">
                    Overwrite Existing
                </button>
            </div>
        </div>
            </div>

        <script>
            var rawNotes = "";
            const selectedTags = new Set();
            const spinner = document.getElementById("loading-spinner");
            function addTag() {
                const dropdown = document.getElementById("tagDropdown");
                const tag = dropdown.value;

                if (tag && !selectedTags.has(tag)) {
                    selectedTags.add(tag);
                    updateTagList(selectedTags);
                }
            }

            function removeTag(tag) {
                selectedTags.delete(tag);
                updateTagList(selectedTags);
            }

            function updateTagList(tagsSet) {
                const tagListDiv = document.getElementById("tagList");
                tagListDiv.innerHTML = ""; // Clear previous tags

                tagsSet.forEach((tag) => {
                    const tagDiv = document.createElement("div");
                    tagDiv.textContent = tag;
                    tagDiv.style.display = "inline-block";
                    tagDiv.style.margin = "5px";
                    tagDiv.style.padding = "5px 10px";
                    tagDiv.style.backgroundColor = "#444";
                    tagDiv.style.color = "#fff";
                    tagDiv.style.borderRadius = "4px";

                    const removeBtn = document.createElement("button");
                    removeBtn.textContent = "x";
                    removeBtn.style.marginLeft = "8px";
                    removeBtn.style.cursor = "pointer";
                    removeBtn.onclick = () => removeTag(tag);

                    tagDiv.appendChild(removeBtn);
                    tagListDiv.appendChild(tagDiv);
                });
            }

            function formatHeader(command) {
                document.execCommand("formatBlock", false, command);
            }
            function format(command) {
                document.execCommand(command, false, null);
            }

            function insertTag(tag) {
                const editor = document.getElementById("NotesInput");
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);

                const tagEl = document.createElement(tag);
                tagEl.innerHTML = " ";
                range.insertNode(tagEl);
                range.collapse(false);
            }

            function insertTooltip() {
                const tooltipText = prompt("Enter tooltip text:");
                if (!tooltipText) return;

                const span = document.createElement("span");
                span.className = "tooltip";
                span.setAttribute("data-tooltip", tooltipText);
                span.textContent = "[?]";

                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                range.insertNode(span);
                range.collapse(false);
            }
            function myFunction() {
                // Get the text field
                var copyText = document.getElementById("shareLink");

                // Select the text field
                copyText.select();
                copyText.setSelectionRange(0, 99999); // For mobile devices

                // Copy the text inside the text field
                navigator.clipboard.writeText(copyText.value);

                // Alert the copied text
                // alert("Copied the text: " + copyText.value);
            }

            document.getElementById("toggleButton").addEventListener("click", function (event) {
                const panel = document.getElementById("overviewPanel");

                if (panel.style.display === "none" || panel.style.display === "") {
                    event.target.innerHTML = "◀ Hide Overview";
                    panel.style.display = "block"; // Show the panel
                } else {
                    event.target.innerHTML = "▶ Show Overview";
                    panel.style.display = "none"; // Hide the panel
                }
            });

            function toggleEditNotes() {
                const notesDisplay = document.getElementById("notesDisplay");
                const notesInput = document.getElementById("NotesInput");
                const notesEditor = document.getElementById("NotesEditInput");
                const editBtn = document.getElementById("editNotesBtn");
                const saveBtn = document.getElementById("saveNotesBtn");
                // console.log(convertHTMLToBrackets(notesDisplay.innerHTML.trim()));
                notesInput.innerHTML = convertHTMLToBrackets(notesDisplay.innerHTML);

                notesInput.innerHTML = convertHTMLToNames(notesInput.innerHTML);
                notesDisplay.style.display = "none";
                notesEditor.style.display = "block";
                editBtn.style.display = "none";
                saveBtn.style.display = "inline-block";
            }

            const excludedTags = ["p", "span", "div", "strong", "em"]; // excluded tags to stop breaking

            function convertHTMLToBrackets(text) {
                return text.replace(/<([a-z0-9]+)><\/\1>/gi, (match, tag) => {
                    return excludedTags.includes(tag.toLowerCase()) ? match : `[${tag}]`;
                });
            }

            function convertNamesToHTML(text) {
                return text.replace(/\{([^}]+)\}/g, (match, name) => {
                    const data = LookUpName(name);
                    if (!data) return match; // Leave unchanged if not found

                    return `<span class="named-tag" style="color: burlywood; display: inline-flex; align-items: center; gap: 4px;">
                    <img src="/aow4db/Icons/TraitIcons/${data.icon}.png" alt="${name}" style="width: 16px; height: 16px;" />
                    ${name}
                </span>`;
                });
            }

            function LookUpName(name) {
                var data = GetCurrentChoiceList().find((entry) => entry.name.indexOf(name) != -1);

                return data;
            }

            function convertHTMLToNames(text) {
                return text.replace(
                    /<span class="named-tag"[^>]*>[\s\S]*?<img[^>]*>\s*([^<]+?)\s*<\/span>/g,
                    (match, name) => `{${name.trim()}}`
                );
            }

            function convertBracketsToHTML(text) {
                return text.replace(/\[([a-z0-9]+)\]/gi, (match, tag) => {
                    return excludedTags.includes(tag.toLowerCase()) ? match : `<${tag}></${tag}>`;
                });
            }

            function saveNotes() {
                const notesDisplay = document.getElementById("notesDisplay");
                const notesInput = document.getElementById("NotesInput");
                const notesEditor = document.getElementById("NotesEditInput");
                const editBtn = document.getElementById("editNotesBtn");
                const saveBtn = document.getElementById("saveNotesBtn");

                notesDisplay.innerHTML = convertBracketsToHTML(notesInput.innerHTML);
                notesDisplay.innerHTML = convertNamesToHTML(notesDisplay.innerHTML);
                rawNotes = notesInput.innerHTML;
                console.log(rawNotes);
                notesDisplay.style.display = "block";
                notesEditor.style.display = "none";
                editBtn.style.display = "inline-block";
                saveBtn.style.display = "none";

                // console.log("Saved HTML:", notesInput.innerHTML);
            }

            function submitBuild2(buildName, tags, notes) {
                var getLink = GenerateQuickLink();
                var currenturl = window.location.href.split("?")[0];
                getLink = currenturl + "?u=" + getLink;

                var userEditKey = getOrCreateUserEditKey();
                var url = new URL(
                    "https://script.google.com/macros/s/AKfycbz5r36EOFcrtfu2Y3CN8DdgDkJDiq6NHf7Y6JEv1IkngOG4we3F5uFU6o5aYFSnm5M4/exec"
                );
                url.searchParams.set("action", "save");
                // actual build settings
                url.searchParams.set("buildName", buildName);
                url.searchParams.set("notes", notes);
                url.searchParams.set("url", getLink);
                url.searchParams.set("tags", tags);
                url.searchParams.set("views", 0);
                url.searchParams.set("editKey", userEditKey);

                spinner.style.display = "block"; // Show the spinner
                fetch(url)
                    .then((res) => res.text())
                    .then((msg) => alert("Submitted: " + msg))
                    .catch((err) => console.error("Submission failed:", err))
                    .finally(() => {
                        spinner.style.display = "none"; // Hide spinner after fetch is done
                    });
            }

            function updateBuild(buildName, notes, oldURL, tags) {
                var getLink = GenerateQuickLink();
                var currenturl = window.location.href.split("?")[0];
                getLink = currenturl + "?u=" + getLink;
                spinner.style.display = "block"; // Show the spinner
                var userEditKey = getOrCreateUserEditKey();
                var url = new URL(
                    "https://script.google.com/macros/s/AKfycbz5r36EOFcrtfu2Y3CN8DdgDkJDiq6NHf7Y6JEv1IkngOG4we3F5uFU6o5aYFSnm5M4/exec"
                );
                url.searchParams.set("action", "edit");
                // actual build settings
                url.searchParams.set("buildName", buildName);
                url.searchParams.set("tags", tags);
                url.searchParams.set("notes", notes);
                url.searchParams.set("oldURL", oldURL);
                url.searchParams.set("newURL", getLink);
                url.searchParams.set("editKey", userEditKey);

                fetch(url)
                    .then((res) => res.text())
                    .then((msg) => alert("Submitted: " + msg))
                    .catch((err) => console.error("Submission failed:", err))
                    .finally(() => {
                        spinner.style.display = "none"; // Hide spinner after fetch is done
                    });
            }

            function getBuildNameAndIcon() {
                var name = document.getElementById("buildName").value;

                return name;
            }

            function GenerateGenericName() {
                return currentTomeList[0].name;
            }

            function overwriteBuild() {
                var oldURLName = document.getElementById("oldURL").innerText;
                // get notes
                var notes = rawNotes;
                const tagArray = Array.from(selectedTags);

                updateBuild(getBuildNameAndIcon(), rawNotes, oldURLName, tagArray);
            }

            // Example usage
            function submitBuild() {
                var buildName = getBuildNameAndIcon();

                //var notes = document.getElementById("NotesInput");
                // console.log(notes + " " + notes.value);
                const tagArray = Array.from(selectedTags);

                submitBuild2(buildName, tagArray, rawNotes);
            }
        </script>
    </body>
</html>
<footer><br /><br /></footer>
